name: Update Terraform Provider

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch: {}

jobs:
  update-terraform-provider:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}

      - name: Check for New Terraform Provider Release
        id: check_release
        run: |
          latest_release=$(gh release list -R scaleway/terraform-provider-scaleway --limit 1)
          latest_version=$(echo $latest_release | awk '{print $1}' | sed 's/^v//')
          echo "Latest version: $latest_version"
          echo "new_version=$latest_version" >> $GITHUB_ENV

      - name: Read Current Terraform Provider Version from Makefile
        id: current_version
        run: |
          current_version=$(awk -F ' := ' '/TERRAFORM_PROVIDER_VERSION/{print $2}' Makefile)
          echo "Current version: $current_version"
          echo "current_version=$current_version" >> $GITHUB_ENV

      - name: Update Makefile
        if: env.new_version != env.current_version
        run: |
          new_version="${{ env.new_version }}"
          sed -i "s/TERRAFORM_PROVIDER_VERSION := .*/TERRAFORM_PROVIDER_VERSION := $new_version/" Makefile
          sed -i "s/TERRAFORM_NATIVE_PROVIDER_BINARY := terraform-provider-scaleway_v.*/TERRAFORM_NATIVE_PROVIDER_B

      - name: Read Current Provider Metadata
        run: |
          echo "CURRENT_METADATA=$(cat config/provider-metadata.yaml)" >> $GITHUB_ENV

      - name: Update Provider Metadata
        run: make generate

      - name: Read New Provider Metadata
        run: |
          echo "NEW_METADATA=$(cat config/provider-metadata.yaml)" >> $GITHUB_ENV

      - name: Set up Go
        uses: actions/setup-go@v2
        with:
          go-version: '1.22'

      - name: Compare Provider Metadata
        id: compare_provider_metadata
        run: echo "::set-output name=resource_configs::$(go run ./config/tools/comparator/main.go)"

      - name: Generate Configurations for New Resources
        run: echo ${{ steps.compare_provider_metadata.outputs.resource_configs }} | go run ./config/tools/generator/main.go

      - name: Commit and Push Changes
        if: env.new_version != env.current_version || steps.compare_provider_metadata.outputs.new_resources
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Update Terraform provider to ${{ env.new_version }} and generate new resources"
          branch: ${{ github.head_ref }}
